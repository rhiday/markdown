
# WebSocket API

WebSocket API utilizes the websocket protocol to forward messages generated by the Kone Siteapi and by Siteflow.  

The websocket address for the Siteflow websocket api messages has the following structure:

```
wss://wsapi.siteflow.kone.com?site_id=<site_id>&x-authorization=<authorization_token>
```

All messages have time and latency fields. The times in these messages are the times of the devices that generate 
the messages. Latencies are calculated based on these times and the times when the messages arrive or are processed 
in the destination devices. For this to work, all devices must be syncronized, and this is achieved by periodically 
syncronizing all devices with NTP servers.

Messages are usually specific to a certian lift, or more generally to a specific group.

## Ping message

The ping messages are sent periodically by the Siteflow system to notify the clients that the connection is active.

```
{
    "ping": 1709890823651
}
```

## Status message

Status messages are sent periodically (currently every 20 seconds), and they are also sent when the status changes. 
There is one status event for every elevator in a group. 

The message has the follwing fields:

- ```source: string```, equal to ```status```
- ```topic: string```, the original topic of the message from group to cloud. The structure of the topic is the following:

    ```from/siteapi/<site_id>/<group_id>/ps_mon_v1/lift_<lift_id>/status```

    where site_id is a string identifying the site, group_id is an integer identifying the group within the site, 
    and lift_id is an integer identifing the lift within the group. For a site the group ids are usually 1, 2, ...
    and for a group the lift ids are 1, 2, 3, ...
- ```site_id: string```, the site id. 
- ```time: string```, the UTC time of the message as generated by the group. 
- ```group_id: int```, the group id.
- ```lift_id: int```, the lift id.
- ```recreated: bool```, optional, default false, true if the event is generated periodically, or false if the event is a result of a status change.
- ```fault_active: bool```, optional
- ```lift_mode: int```, value 0 = lift is operating normally, value -1 = lift is offline. Currently over 50 different modes. They are listed in the table below.
- ```in_bank: bool```, optional, Lift is operating as part of the group.
- ```nominal_speed: decimal```, optional. Lift nominal speed
- ```decks: array<area:int, alarm: bool, accepted_call_actions: array<int>>```, 
  An array of objects. Area field is required and it is the area id of the deck.
  Alarm is optional and is true if the alarm has been pressed in the lift. accepted_call_actions is optional. 
  If car/deck has limitations on what call types it accepts, then they are listed in accepted_call_actions.
- ```lift_latency: int```, The latency of the message from the moment it was generated by the group, until it was processed and forwarded via the websocket. 
  This depends on the speed of the (mobile) internet connection, and it could vary significantly if the GSM signal is not stable.
- ```iot_latency: int```, The latency of the message within the cloud processing pipelines.

Lift modes

|Abbreviation|Code|Description|
|-----|-----|-----|
|NOR|0|Lift is normal mode.|
|SRV|1|The lift has been switched to inspection drive by maintenance personnel.|
|FRD|2|The lift has been switched to fireman's service.|
|EPD|3|The lift is running under emergency power supply|
|ATS|4|The lift is controlled manually by an attendant in the car.|
|FSC|5|The lift is used for freight service, and it is not available for normal passengers.|
|VIP|6|The lift is reserved for special VIP service, and it is not available for normal passengers.|
|OSS|7|The lift is switched to out of service and does not operate.|
|PRC|8|The lift is switched to independent service, and it is controlled only with car call buttons.|
|HES|9|The lift has received a hospital emergency hall call and will only serve that call. No other passenger requests are accepted.|
|BED|10|The lift is in hospital bed service mode. Only one landing call at a time is served and each landing call gets an empty car.|
|PRH|11|The lift is serving a high priority landing call and does not accept any other hall calls before the priority call has been served.|
|PRL|12|As PRH, except that each priority call is assigned to an empty car.|
|SIM|13|This option is designed to allow one specified lift to be removed from normal group service to answer a separate set of landing call buttons in full collective mode.|
|EFA|14|Lift has failed and is unable to drive. More information of the reason can be found faults.|
|PAD|15|The lift has been switched to special parking mode. It drives normally, except that it is always parked at a special floor when it becomes free. It is disconnected from normal parking operations.|
|RDR|16|A procedure to dispatch lifts in abnormal situations. The lift is controlled manually from inside the car. It is not serving normal passengers.|
|DIS|17|The lift has been disconnected from landing calls with a switch in the control panel.|
|NOC|18|This is useful in proxy cases when connection between lift proxy and lift is broken.|
|STP|19|The lift has stopped due to a break in the safety chain.|
|EAQ|20|The lift is in earthquake mode.|
|FRE|21|The lift drives directly to the specified floor and stays there with the doors closed.|
|HEC|22|The lift is in car hospital service. Drives only from car calls.|
|RDM|23|The lift is in reserve dispatch mode. Special mode when all risers are in failure mode and lift collect passengers according to predefined pattern.|
|AGV|26|The lift is reserved to transport automated guided vehicle.|
|HWO|27|For safety reasons the lift reduces speed when strong winds are detected.|
|SWL|28|For safety reasons the lift stops running when storm winds are detected.|
|RES|29|The lift speed is reduced.|
|EVA|30|The lift operates in evacuation mode.|
|CAP|31|The lift is switched to cleaning mode, but it is still driving the existing passengers before going some CAM mode.|
|CAM|32|The lift is reserved for cleaning and it is not available for normal passengers.|
|OSP|33|The lift is switched to some maintenance mode, but it is still driving the existing passengers before going some SRV or OSS mode.|
|INV|34|The lift operates in invasion mode.|
|SET|35|The lift is doing setup drive.|
|SRM|36|Lift is in substance release mode.|
|FID|37|Lift is in fire detection mode.|
|FID_M|38|Lift is in fire detection mode. Fire detected in machine room|
|PVS|39|Lift is in penthouse visitor service mode|
|PGS|40|Priority Good Service. The lift is reserved for moving goods/baggage/products/non-human objects|
|REC|41|Recover. Group sets lift to this mode if group needs to recover the lift status and can’t temporarily command the lift.|
||42|Reserved (not used in this protocol)|
|CTL|43|Car to lobby mode. Lift is requested to go into a specific lobby and to wait for additional actions|
|PET|44|The lift is in PET mode i.e. transferring a pet which has additional signalization|
|EMP|45|Empty car - lift reserved to serve a call where lift car needs to be empty|
|MES|46|Lift is reserved for medical emergency service|
|REM|47|Lift is reserved for retail mode|
|LVP|48|Lift is serving low priority VIP call|
|HVP|49|Lift is serving high priority VIP call|
|CVP|50|Lift is reserved for VIP calls only|
|PDC|51|Lift is in Pandemic mode|
|TRF|52|Lift set to Transformer mode|
||53|Reserved – not used in this protocol (LCE uses this with C-process ATS)|
||54|Reserved – not used in this protocol (LCE uses this with C-process PRC)|
|PIT|55|Pit inspection failure|
|LUG|56|Luggage handling feature|
|TCA_R|57|Technician roof access – Lift is set to roof access mode for technician|
|TCA_P|58|Technician pit access – Lift is set to pit access mode for technician|
|BTF|59|Break test failure|
|RIM|60|Remote intervention – remote maintenance operations on-going|



Next there is an example of a status message.

```
{
    "source": "status",
    "topic": "from/siteapi/35d45a7f7d274c84878ee394d141fa6a/1/ps_mon_v1/lift_1/status",
    "site_id": "35d45a7f7d274c84878ee394d141fa6a",
    "time": "2024-03-08T09:40:21.454Z",
    "group_id": 1,
    "lift_id": 1,
    "recreated": true,
    "fault_active": false,
    "lift_mode": 0,
    "in_bank": true,
    "nominal_speed": 1,
    "decks": [
        {
            "area": 1001010,
            "alarm": false
        }
    ],
    "lift_latency": 249,
    "iot_latency": 98
}
```

## Locks message

Locks messages are sent periodically (currently every 20 seconds), and they are also sent when the locks change. 
There is one locks event for every elevator in a group. 

The message has the follwing fields:

- ```source: string```, equal to ```locks```
- ```topic: string```, the original topic of the message from group to cloud. The structure of the topic is the following:

    ```from/siteapi/<site_id>/<group_id>/ps_mon_v1/lift_<lift_id>/locks```

    where site_id is a string identifying the site, group_id is an integer identifying the group within the site, 
    and lift_id is an integer identifing the lift within the group. For a site the group ids are usually 1, 2, ...
    and for a group the lift ids are 1, 2, 3, ...
- ```site_id: string```, the site id. 
- ```time: string```, the UTC time of the message as generated by the group. 
- ```group_id: int```, the group id.
- ```lift_id: int```, the lift id.
- ```recreated: bool```, optional, default false, true if the event is generated periodically, or false if the event is a result of a locks change.
- ```decks: array<deck_area:int, locks: array<[int, int]>>```, An array of objects. deck_area is the area id of the lift deck. 
locks is a list of two elements lists (landing area id and locks encoding). The locks encoding is an integer between 0 and 15:
LSB: bit 0 = In-Up, bit 1 = In-Down, bit 2 = In-Non-Directional, bit 3 = Out. Here are some examples 
(note that some call types are considered directionless, thus bit 2):
    - 15 = Completely Locked; this deck will not visit this area
    - 8 = Exit locked; this deck will not drop off any passengers here, but can pick up new ones
    - 7 = Entry locked; this deck will not pick up any passengers here, but can drop off some
    - 2 = Down locked; this deck will not pick any down-bound passengers here, otherwise no limitations
    - 1 = Up locked; this deck will not pick any up-bound passengers here, otherwise no limitations
    - 0 = Completely open; no limitations
- ```lift_latency: int```, The latency of the message from the moment it was generated by the group, until it was processed and forwarded via the websocket. 
  This depends on the speed of the (mobile) internet connection, and it could vary significantly if the GSM signal is not stable.
- ```iot_latency: int```, The latency of the message within the cloud processing pipelines.

Next there is an example of a locks message.

```
{
    "source": "locks",
    "topic": "from/siteapi/35d45a7f7d274c84878ee394d141fa6a/1/ps_mon_v1/lift_1/locks",
    "site_id": "35d45a7f7d274c84878ee394d141fa6a",
    "time": "2024-03-11T10:35:35.647Z",
    "group_id": 1,
    "lift_id": 1,
    "recreated": true,
    "decks": [
        {
            "deck_area": 1003010,
            "locks": [
                [ 4000, 7 ],
                [ 5000, 15 ]
            ]
        }
    ],
    "iot_latency": 97,
    "lift_latency": 239
}
```

## Doors message

Doors messages are sent when door events occur (openning, closing, ...).  The doors messages are lift specific.

The doors message has the follwing fields:

- ```source: string```, equal to ```doors```
- ```topic: string```, the original topic of the message from group to cloud. The structure of the topic is the following:

    ```from/siteapi/<site_id>/<group_id>/ps_mon_v1/lift_<lift_id>/doors```

    where site_id is a string identifying the site, group_id is an integer identifying the group within the site, 
    and lift_id is an integer identifing the lift within the group. For a site the group ids are usually 1, 2, ...
    and for a group the lift ids are 1, 2, 3, ...
- ```site_id: string```, the site id.
- ```time: string```, the UTC time of the message as generated by the group. 
- ```group_id: int```, the group id.
- ```lift_id: int```, the lift id.
- ```area: int```, deck area id. This field identified the lift and the deck within a group. The field area should be used 
instead of lift_id to identify the lift.
- ```landing: int```, optional, Area id of a landing the door leads to, if any.
- ```lift_side: int```, Lift side of the door.
- ```state: string```, The door state. Possible values are: STOPPED, OPENING, OPENED, CLOSING, CLOSED, NUDGING, ERROR.
- ```lift_latency: int```, The latency of the message from the moment it was generated by the group, until it was processed and forwarded via the websocket. 
  This depends on the speed of the (mobile) internet connection, and it could vary significantly if the GSM signal is not stable.
- ```iot_latency: int```, The latency of the message within the cloud processing pipelines.

Next there is an example of a doors message.

```
{
    "source": "doors",
    "topic": "from/siteapi/35d45a7f7d274c84878ee394d141fa6a/1/ps_mon_v1/lift_1/doors",
    "site_id": "35d45a7f7d274c84878ee394d141fa6a",
    "time": "2024-03-08T09:16:04.298Z",
    "group_id": 1,
    "lift_id": 1,
    "area": 1001010,
    "landing": 1000,
    "lift_side": 1,
    "state": "CLOSED",
    "iot_latency": 97,
    "lift_latency": 239
}
```

## Position message

Position messages are sent when the position of the lift changes.  The position messages are lift specific.

The position message has the follwing fields:

- ```source: string```, equal to ```position```
- ```topic: string```, the original topic of the message from group to cloud. The structure of the topic is the following:

    ```from/siteapi/<site_id>/<group_id>/ps_mon_v1/lift_<lift_id>/position```

    where site_id is a string identifying the site, group_id is an integer identifying the group within the site, 
    and lift_id is an integer identifing the lift within the group. For a site the group ids are usually 1, 2, ...
    and for a group the lift ids are 1, 2, 3, ...
- ```site_id: string```, the site id.
- ```time: string```, the UTC time of the message as generated by the group. 
- ```group_id: int```, the group id.
- ```lift_id: int```, the lift id.
- ```area: int```, deck area id. This field identified the lift and the deck within a group. The field area should be used 
instead of lift_id to identify the lift.
- ```recreated: bool```, optional, default false, Default: false. Provided if event is recreated as a response to activation.
- ```dir: string```, Enumeration, values: NONE, UP, DOWN.
- ```coll: string```,  Enumeration, values: NONE, UP, DOWN.
- ```moving_state: string```, Enumeration, values: STOPPED, STANDING, STARTING, MOVING, DECELERATING.
- ```drive_mode: string```, optional. Values: Normal, Releveling, Correction, Service, Setup, Sync. Not implemented yet.
- ```door: bool```, optional. Deck is at a door zone.
- ```adv: int```,  Group floor id.
- ```cur: int```, Group floor id.
- ```serving_mode: string```, optional. Values: Unknown, Vacant, Busy, CarCallPreference. Not implemented yet.
- ```deck_mode: string```, optional. Values: Normal, Loading, Cleaning, OutOfService. Not implemented yet.
- ```lift_latency: int```, The latency of the message from the moment it was generated by the group, until it was processed and forwarded via the websocket. 
  This depends on the speed of the (mobile) internet connection, and it could vary significantly if the GSM signal is not stable.
- ```iot_latency: int```, The latency of the message within the cloud processing pipelines.

Next there is an example of a position message.

```
{
    "source": "position",
    "topic": "from/siteapi/35d45a7f7d274c84878ee394d141fa6a/1/ps_mon_v1/lift_1/position",
    "site_id": "35d45a7f7d274c84878ee394d141fa6a",
    "time": "2024-03-08T09:37:49.864Z",
    "group_id": 1,
    "lift_id": 1,
    "area": 1001010,
    "dir": "NONE",
    "coll": "NONE",
    "door": true,
    "adv": 2,
    "cur": 2,
    "moving_state": "STANDING",
    "serving_mode": "VACANT",
    "drive_mode": "NORMAL",
    "iot_latency": 97,
    "lift_latency": 239
}
```

## actionSession message

Message actionSession is sent whenever there is a change in the status of an elevator
action or if the action is still open and there has been no change for 5 s. The message
is specific to a group, and the involved lift (decks) are listed in the field
```allocated_lift_deck```.

The actionSession message has the follwing fields:

- ```source: string```, equal to ```actionSession```
- ```topic: string```, equal to ```/actionSession```
- ```site_id: string```, the site id.
- ```time: string```, the UTC time when action was initiated.
- ```group_id: int```, the group id.
- ```session_id: int```, the session id.
- ```start: string```, the UTC time when action was initiated.

- ```allocated_lift_deck: array<int>```, area ids of elevator(s) that are under consideration or allocated.
- ```state: string```, Values: registered, being_assigned, assigned, being_fixed, fixed, being_served, served_soon, served, cancelled.
- ```request_id: int```, optional, identifier of the action request.
- ```origin: string```, origin of action.
- ```terminal: int```, optional, where the action was initiated.
- ```call: {session_id: int, action: int, destination: int}```, identifier of this action, its type and destination if action has one. 
Action types: 2000 - landing call, 2001 - landing call up, 2002 - landing call down, 5000 - car call, 9001 - priority call.
- ```success: bool```, whether request was accepted.
- ```area: int```, area id where the action was initiated.
- ```lift_latency: int```, Time since the initiation of action until message sent to websocket. Does not reflect communication latency.
- ```iot_latency: int```, The latency of the message within the cloud processing pipelines.



```
{
    "source": "actionSession",
    "topic": "/actionSession",
    "time": "2024-03-11T12:09:07.987Z",
    "group_id": "2",
    "session_id": "130",
    "site_id": "0bd4fa018c894eb196b22cf47e3e1963",
    "start": "2024-03-11T12:09:07.987Z",
    "allocated_lift_deck": [
        1001010
    ],
    "state": "served_soon",
    "request_id": "90259",
    "origin": "API",
    "terminal": 0,
    "call": {
        "session_id": 130,
        "action": 2,
        "destination": 7010
    },
    "success": true,
    "area": 8010,
    "iot_latency": 1710158973154,
    "lift_latency": 25167
}
```